// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  fname               String?
  lname               String?
  firstName           String?
  code                String    @unique
  referralCode        String    @unique
  referredBy          String?
  createdAt           DateTime  @default(now())
  points              Int       @default(0)
  earnedPurchaseBook  Boolean   @default(false)
  rabbit1Completed    Boolean   @default(false)
  rabbitStep          Int       @default(500)
  rabbitTarget        Int?
  rabbitCatches       Int       @default(0)
  lastRabbitBonusIntent String?
  rabbitSeq           Int       @default(1)
  lastRabbitCatchAt   DateTime?
  phone               String?
  handleX             String?
  handleInstagram     String?
  handleTiktok        String?
  handleTruth         String?
  referralEarningsCents Int     @default(0)
  events              Event[]
  badges              UserBadge[]
  posts               Post[]
  purchases           Purchase[]
  ledger              Ledger[]
  referralConversions ReferralConversion[]

  @@index([referralCode])
}

model Ledger {
  id        String     @id @default(cuid())
  userId    String
  type      LedgerType
  points    Int        @default(0)
  usd       Decimal    @default(0)
  note      String?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

enum LedgerType {
  PURCHASE_BOOK
  REFER_FRIEND_PAYOUT
  MANUAL_ADJUST
  SHARE_X
  SHARE_IG
  SHARE_FB
  SHARE_TRUTH
  SHARE_TT
  CONTEST_JOIN
  SUBSCRIBE_DIGEST
  TRIVIA
  RABBIT_BONUS
  SIGNUP_BONUS
}

model Event {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  type      String
  meta      Json?
  createdAt DateTime @default(now())

  @@index([userId, type, createdAt])
}

model Badge {
  id           String      @id @default(cuid())
  slug         String      @unique
  title        String
  points       Int
  actionType   String
  actionUrl    String?
  cooldownHrs  Int?
  maxTimes     Int         @default(1)
  active       Boolean     @default(true)
  userBadges   UserBadge[]  // ADD THIS LINE
}

model UserBadge {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  badge       Badge    @relation(fields: [badgeId], references: [id])
  badgeId     String
  times       Int      @default(1)
  lastEarned  DateTime @default(now())

  @@unique([userId, badgeId])
}

model Post {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  content   String
  status    String   @default("approved")
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Purchase {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  sessionId String   @unique
  amount    Int?
  currency  String?
  source    String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model ReferralConversion {
  id              String    @id @default(cuid())
  referrerUserId  String
  referralCode    String
  buyerEmail      String?
  stripeSessionId String    @unique
  commissionCents Int
  createdAt       DateTime  @default(now())
  lastDigestDate  DateTime? // Date when this conversion was included in a digest
  referrer         User      @relation(fields: [referrerUserId], references: [id])

  @@index([referrerUserId, createdAt])
  @@index([referralCode])
  @@index([lastDigestDate])
}